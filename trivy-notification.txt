how to build then scan docker image using trivy in github action and sent the notification when getting critical and send another sns notification when high vulnerability, if no vulnerability then push to ecr

To build and scan a Docker image using Trivy in a GitHub Action, and then send an SNS notification when critical or high vulnerabilities are found, or push the image to Amazon Elastic Container Registry (ECR) if there are no vulnerabilities, you can follow these steps:

1. Create two SNS topics and subscriptions:

In the AWS Management Console, navigate to SNS.
Create two new topics and subscriptions, and make note of the ARNs for the subscriptions.

2. Install Trivy:


Add the following step to your GitHub Actions workflow file:


- name: Install Trivy
  run: |
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin


3. Build the Docker image:

Add the following step to your workflow file:

- name: Build Docker image
  run: docker build -t my-image:latest .


4. Scan the Docker image using Trivy:

Add the following step to your workflow file:

- name: Scan Docker image using Trivy
  id: trivy
  run: |
    trivy --exit-code 1 --severity HIGH,CRITICAL my-image:latest
  continue-on-error: true


This will scan the Docker image using Trivy and exit with a non-zero status code if any high or critical vulnerabilities are found. The continue-on-error flag is set to true to allow the workflow to continue even if there are vulnerabilities.

5. Send an SNS notification if critical vulnerabilities are found:

Add the following step to your workflow file:

- name: Notify if critical vulnerabilities are found
  if: steps.trivy.outputs.exit_code == '1' && contains(steps.trivy.outputs.stdout, 'CRITICAL')
  env:
    AWS_REGION: us-west-2
    SNS_TOPIC_ARN: arn:aws:sns:us-west-2:123456789012:my-critical-topic
  run: |
    aws sns publish --topic-arn $SNS_TOPIC_ARN --region $AWS_REGION --message "Critical vulnerabilities found in Docker image"


This step will check the exit code of the previous step (the Trivy scan) and the output to see if any critical vulnerabilities were found. If so, it will send an SNS notification to the critical vulnerabilities topic. You will need to set the AWS_REGION and SNS_TOPIC_ARN environment variables to the appropriate values for your AWS region and SNS topic ARN.

6. Send an SNS notification if high vulnerabilities are found:

Add the following step to your workflow file:

- name: Notify if high vulnerabilities are found
  if: steps.trivy.outputs.exit_code == '1' && contains(steps.trivy.outputs.stdout, 'HIGH')
  env:
    AWS_REGION: us-west-2
    SNS_TOPIC_ARN: arn:aws:sns:us-west-2:123456789012:my-high-topic
  run: |
    aws sns publish --topic-arn $SNS_TOPIC_ARN --region $AWS_REGION --message "High vulnerabilities found in Docker image"


This step will check the exit code of the previous step (the Trivy scan) and the output to see if any high vulnerabilities were found. If so, it will send an SNS notification to the high vulnerabilities topic. You will need to set the AWS_REGION and SNS_TOPIC_ARN environment variables to the appropriate values for your AWS region and SNS


